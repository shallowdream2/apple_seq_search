<!--warranty.wxml-->
<view class="page">
  <!-- 序列号信息 -->
  <view class="serial-bar">
    <text class="serial-label">序列号</text>
    <text class="serial-value">{{serial}}</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-card" wx:if="{{step === 'loading' || step === 'submitting'}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{step === 'loading' ? '正在获取验证码...' : '正在查询保修信息...'}}</text>
  </view>

  <!-- 验证码输入 -->
  <block wx:if="{{step === 'captcha'}}">
    <view class="captcha-card">
      <text class="captcha-title">请输入验证码</text>
      <text class="captcha-desc">验证码来自 Apple 官网，输入后即可查询保修状态</text>

      <view class="captcha-image-wrap">
        <image
          class="captcha-image"
          src="{{captchaImage}}"
          mode="aspectFit"
          bindtap="onRefreshCaptcha"
        />
        <view class="captcha-refresh" bindtap="onRefreshCaptcha">
          <text class="refresh-text">换一张</text>
        </view>
      </view>

      <view class="captcha-input-wrap">
        <input
          class="captcha-input"
          placeholder="输入图中的字符"
          placeholder-class="captcha-placeholder"
          value="{{captchaInput}}"
          bindinput="onCaptchaInput"
          bindconfirm="onSubmit"
          maxlength="10"
          adjust-position="{{true}}"
        />
      </view>

      <view class="btn-submit" bindtap="onSubmit">查询保修状态</view>
    </view>
  </block>

  <!-- 查询结果 -->
  <block wx:if="{{step === 'result' && result}}">
    <!-- 状态卡片 -->
    <view class="status-card status-{{result.status}}">
      <text class="status-icon">{{result.status === 'active' ? '✅' : result.status === 'expired' ? '⚠️' : 'ℹ️'}}</text>
      <text class="status-text">{{result.statusText}}</text>
      <text class="status-desc" wx:if="{{result.statusDesc}}">{{result.statusDesc}}</text>
    </view>

    <!-- 产品名称 -->
    <view class="info-card" wx:if="{{result.productName}}">
      <view class="info-item">
        <text class="info-label">产品</text>
        <text class="info-value">{{result.productName}}</text>
      </view>
    </view>

    <!-- 保修详情 -->
    <view class="info-card" wx:if="{{result.coverageItems && result.coverageItems.length > 0}}">
      <view
        class="info-item"
        wx:for="{{result.coverageItems}}"
        wx:key="label"
      >
        <text class="info-label">{{item.label}}</text>
        <text class="info-value {{item.active ? 'text-active' : 'text-expired'}}">{{item.value}}</text>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-section">
      <view class="btn-retry" bindtap="onRetry">重新查询</view>
      <view class="btn-back" bindtap="onBack">返回</view>
    </view>
  </block>

  <!-- 错误状态 -->
  <block wx:if="{{step === 'error'}}">
    <view class="error-card">
      <text class="error-icon">❌</text>
      <text class="error-text">{{errorMsg}}</text>
      <view class="btn-retry" bindtap="onRetry">重试</view>
      <view class="btn-back" bindtap="onBack">返回</view>
    </view>
  </block>
</view>
